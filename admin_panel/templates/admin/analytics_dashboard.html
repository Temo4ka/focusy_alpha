{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ - {{ block.super }}{% endblock %}

{% block extrahead %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    .stat-card {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
    }
    .stat-value {
        font-size: 2.5em;
        font-weight: bold;
        color: #0066cc;
        display: block;
    }
    .stat-label {
        color: #6c757d;
        margin-top: 5px;
    }
    .section {
        margin: 30px 0;
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .section h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #0066cc;
        padding-bottom: 10px;
    }
    .user-list, .task-list, .mission-list {
        list-style: none;
        padding: 0;
    }
    .user-list li, .task-list li, .mission-list li {
        padding: 10px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .user-list li:last-child, .task-list li:last-child, .mission-list li:last-child {
        border-bottom: none;
    }
    .badge {
        background: #0066cc;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
    }
    .success { background: #28a745; }
    .warning { background: #ffc107; color: #212529; }
    .danger { background: #dc3545; }
</style>
{% endblock %}

{% block content %}
<h1>üìä –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–Ω–µ–ª—å FOCUSY</h1>

<!-- –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="stats-grid">
    <div class="stat-card">
        <span class="stat-value">{{ stats.total_users }}</span>
        <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ stats.total_tasks }}</span>
        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞–Ω–∏–π</div>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ stats.active_tasks }}</span>
        <div class="stat-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞–Ω–∏–π</div>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ stats.total_attempts }}</span>
        <div class="stat-label">–í—Å–µ–≥–æ –ø–æ–ø—ã—Ç–æ–∫</div>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ stats.completed_missions }}</span>
        <div class="stat-label">–ó–∞–≤–µ—Ä—à–µ–Ω–æ –º–∏—Å—Å–∏–π</div>
    </div>
    <div class="stat-card">
        <span class="stat-value">{{ recent_stats.new_users }}</span>
        <div class="stat-label">–ù–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (30 –¥–Ω–µ–π)</div>
    </div>
</div>

<!-- –ì—Ä–∞—Ñ–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
<div class="section">
    <h3>üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
    <canvas id="activityChart" width="400" height="150"></canvas>
</div>

<!-- –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ -->
<div class="section">
    <h3>üèÜ –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–æ –æ–ø—ã—Ç—É</h3>
    <ul class="user-list">
        {% for user in top_users %}
        <li>
            <span>
                <strong>{{ user.name }}</strong> 
                (ID: {{ user.user_id }})
                <span class="badge">–£—Ä–æ–≤–µ–Ω—å {{ user.level }}</span>
            </span>
            <span>
                {{ user.experience_points }} XP | 
                {{ user.coins }} üí∞
            </span>
        </li>
        {% endfor %}
    </ul>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞–Ω–∏–π -->
<div class="section">
    <h3>üìù –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–¥–∞–Ω–∏—è</h3>
    <ul class="task-list">
        {% for task in task_stats %}
        <li>
            <span>
                <strong>–ó–∞–¥–∞–Ω–∏–µ #{{ task.task_id }}</strong>
                <span class="badge {% if task.difficulty == 1 %}success{% elif task.difficulty == 2 %}warning{% else %}danger{% endif %}">
                    {{ task.get_difficulty_display }}
                </span>
            </span>
            <span>
                {{ task.attempts_count }} –ø–æ–ø—ã—Ç–æ–∫ |
                {% if task.attempts_count > 0 %}
                    {{ task.correct_count|floatformat:0 }}/{{ task.attempts_count }} 
                    ({{ task.correct_count|mul:100|div:task.attempts_count|floatformat:1 }}%)
                {% else %}
                    0%
                {% endif %}
            </span>
        </li>
        {% endfor %}
    </ul>
</div>

<!-- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∏—Å—Å–∏–∏ -->
<div class="section">
    <h3>üéØ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–∏—Å—Å–∏–∏</h3>
    <ul class="mission-list">
        {% for mission in popular_missions %}
        <li>
            <span>
                <strong>{{ mission.title }}</strong>
                <span class="badge">{{ mission.reward_exp }} XP + {{ mission.reward_coins }} üí∞</span>
            </span>
            <span>{{ mission.completions }} –∑–∞–≤–µ—Ä—à–µ–Ω–∏–π</span>
        </li>
        {% endfor %}
    </ul>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
<div class="section">
    <h3>‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
    <p>
        <a href="{% url 'admin:content_management_task_add' %}" class="button">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</a>
        <a href="{% url 'admin:content_management_mission_add' %}" class="button">üéØ –°–æ–∑–¥–∞—Ç—å –º–∏—Å—Å–∏—é</a>
        <a href="/analytics/user-progress/" class="button">üìä –û—Ç—á–µ—Ç –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º</a>
        <a href="/analytics/content-performance/" class="button">üìà –ê–Ω–∞–ª–∏–∑ –∫–æ–Ω—Ç–µ–Ω—Ç–∞</a>
    </p>
</div>

<script>
// –ì—Ä–∞—Ñ–∏–∫ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
fetch('/analytics/user-activity/?days=30')
    .then(response => response.json())
    .then(data => {
        const ctx = document.getElementById('activityChart').getContext('2d');
        
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        const dates = [...new Set([
            ...data.registrations.map(r => r.day),
            ...data.attempts.map(a => a.day)
        ])].sort();
        
        const registrationData = dates.map(date => {
            const item = data.registrations.find(r => r.day === date);
            return item ? item.count : 0;
        });
        
        const attemptData = dates.map(date => {
            const item = data.attempts.find(a => a.day === date);
            return item ? item.count : 0;
        });
        
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [{
                    label: '–ù–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
                    data: registrationData,
                    borderColor: '#0066cc',
                    backgroundColor: 'rgba(0, 102, 204, 0.1)',
                    tension: 0.1
                }, {
                    label: '–ü–æ–ø—ã—Ç–∫–∏ –∑–∞–¥–∞–Ω–∏–π',
                    data: attemptData,
                    borderColor: '#28a745',
                    backgroundColor: 'rgba(40, 167, 69, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    });
</script>
{% endblock %}
